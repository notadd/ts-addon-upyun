{"version":3,"sources":["util/restful.util.ts"],"names":[],"mappings":"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","file":"restful.util.js","sourcesContent":["\nimport { Injectable, HttpException, Inject } from \"@nestjs/common\";\nimport * as fs from \"fs\";\nimport * as mime from \"mime\";\nimport * as request from \"request\";\nimport { ImagePreProcessInfo } from \"../interface/file/image.process.info\";\nimport { Audio } from \"../model/audio.entity\";\nimport { Bucket } from \"../model/bucket.entity\";\nimport { Document } from \"../model/document.entity\";\nimport { File } from \"../model/file.entity\";\nimport { Image } from \"../model/image.entity\";\nimport { Video } from \"../model/video.entity\";\nimport { AuthUtil } from \"../util/auth.util\";\nimport { ProcessStringUtil } from \"./process.string.util\";\n\n/* 包含了restfulAPI的各种功能\n   删除文件、创建目录、删除目录、获取文件信息、获取目录文件列表、获取服务使用量\n*/\n@Injectable()\nexport class RestfulUtil {\n    private readonly apihost = \"https://v0.api.upyun.com\";\n\n    constructor(\n        @Inject(AuthUtil) private readonly authUtil: AuthUtil,\n        @Inject(ProcessStringUtil) private readonly processStringUtil: ProcessStringUtil\n    ) {\n    }\n\n    // 上传文件，其中文件信息来自于formidable解析得到的File对象\n    async uploadFile(bucket: Bucket, file: File | Image | Video | Audio | Document, uploadFile: any, imagePreProcessInfo: ImagePreProcessInfo): Promise<{ width: number, height: number, frames: number }> {\n        const contentMd5 = file.md5;\n        const saveKey = `/${bucket.directory}/${file.name}.${file.type}`;\n        const requestUrl = `${this.apihost}/${bucket.name}${saveKey}`;\n        const url = `/${bucket.name}${saveKey}`;\n        const date: string = new Date(+new Date() + bucket.requestExpire * 1000).toUTCString();\n        const Authorization = await this.authUtil.getHeaderAuth(bucket, \"PUT\", url, date, contentMd5);\n        const format = bucket.imageConfig.format || \"raw\";\n        let xGmkerlThumb = this.processStringUtil.makeImageProcessString(bucket, imagePreProcessInfo);\n        if (format === \"raw\") {\n            xGmkerlThumb += \"/scale/100\";\n        } else if (format === \"webp_damage\") {\n            xGmkerlThumb += \"/format/webp/strip/true\";\n        } else {\n            xGmkerlThumb += \"/format/webp/lossless/true/strip/true\";\n        }\n        const headers: any = await new Promise((resolve, reject) => {\n            fs.createReadStream(uploadFile.path).pipe(request.put({\n                url: requestUrl,\n                headers: {\n                    \"Content-Type\": mime.getType(uploadFile.path),\n                    \"Content-MD5\": contentMd5,\n                    Authorization,\n                    \"Date\": date,\n                    \"x-gmkerl-thumb\": xGmkerlThumb\n                }\n            }, (err, res, body) => {\n                if (err) {\n                    reject(new HttpException(\"文件上传失败,网络错误\", 402));\n                    return;\n                }\n                if (res.statusCode === 200) {\n                    resolve(res.headers);\n                    return;\n                }\n                if (body) {\n                    try {\n                        const { msg, code, id } = JSON.parse(body);\n                        reject(new HttpException(msg, code));\n                    } catch (err) {\n                        reject(new HttpException(\"响应体解析错误\", 402));\n                    }\n                } else {\n                    reject(new HttpException(\"响应体不存在\", 402));\n                }\n                return;\n            }));\n        });\n        return {\n            width: headers[\"x-upyun-width\"],\n            height: headers[\"x-upyun-height\"],\n            frames: headers[\"x-upyun-frames\"]\n        };\n    }\n\n    /*创建指定空间里的指定目录，空间下唯一目录在配置中指定\n        @Param bucket：目录所属空间\n    */\n    async createDirectory(bucket: Bucket): Promise<void> {\n        const requestUrl = `${this.apihost}/${bucket.name}/${bucket.directory}`;\n        const url = `/${bucket.name}/${bucket.directory}`;\n        const date: string = new Date(+new Date() + bucket.requestExpire * 1000).toUTCString();\n        const Authorization = await this.authUtil.getHeaderAuth(bucket, \"POST\", url, date, undefined);\n        await new Promise((resolve, reject) => {\n            request.post({\n                url: requestUrl,\n                headers: {\n                    Authorization,\n                    Date: date,\n                    folder: true\n                }\n            },\n                (err, res, body) => {\n                    if (err) {\n                        reject(new HttpException(\"目录创建失败，网络错误\", 402));\n                        return;\n                    }\n                    if (res.statusCode === 200) {\n                        resolve();\n                        return;\n                    }\n                    if (body) {\n                        try {\n                            const { msg, code, id } = JSON.parse(body);\n                            reject(new HttpException(msg, code));\n                        } catch (err) {\n                            reject(new HttpException(\"响应体解析错误\", 402));\n                        }\n                    } else {\n                        reject(new HttpException(\"响应体不存在\", 402));\n                    }\n                    return;\n                });\n        });\n        return;\n    }\n\n    /* 删除指定空间指定文件\n       @Param bucket：文件所属空间\n       @Param file：文件对象\n     */\n    async deleteFile(bucket: Bucket, file: File | Image | Video | Audio | Document): Promise<void> {\n        const savekey = `/${bucket.directory}/${file.name}.${file.type}`;\n        const requestUrl = `${this.apihost}/${bucket.name}${savekey}`;\n        const url = `/${bucket.name}${savekey}`;\n        const date: string = new Date(+new Date() + bucket.requestExpire * 1000).toUTCString();\n        const Authorization = await this.authUtil.getHeaderAuth(bucket, \"DELETE\", url, date, \"\");\n        await new Promise((resolve, reject) => {\n            request.delete({\n                url: requestUrl,\n                headers: {\n                    Authorization,\n                    Date: date\n                }\n            }, (err, res, body) => {\n                if (err) {\n                    reject(new HttpException(\"删除文件失败\", 402));\n                    return;\n                }\n                if (res.statusCode === 200) {\n                    resolve();\n                    return;\n                }\n                if (body) {\n                    try {\n                        const { msg, code, id } = JSON.parse(body);\n                        reject(new HttpException(msg, code));\n                    } catch (err) {\n                        reject(new HttpException(\"响应体解析错误\", 402));\n                    }\n                } else {\n                    reject(new HttpException(\"响应体不存在\", 402));\n                }\n                return;\n            });\n        });\n        return;\n    }\n\n    /* 获取指定文件的保存信息\n     */\n    async getFileInfo(bucket: Bucket, file: File | Image | Video | Audio | Document): Promise<{ fileSize: number, fileDate: any, fileMd5: string }> {\n        const savekey = `/${bucket.directory}/${file.name}.${file.type}`;\n        const requestUrl = `${this.apihost}/${bucket.name}${savekey}`;\n        const url = `/${bucket.name}${savekey}`;\n        const date: string = new Date(+new Date() + bucket.requestExpire * 1000).toUTCString();\n        const Authorization = await this.authUtil.getHeaderAuth(bucket, \"HEAD\", url, date, \"\");\n        const headers: any = await new Promise((resolve, reject) => {\n            request.head({\n                url: requestUrl,\n                headers: {\n                    Authorization,\n                    Date: date\n                }\n            }, (err, res, body) => {\n                if (err) {\n                    reject(new HttpException(\"获取文件信息失败\", 402));\n                    return;\n                }\n                if (res.statusCode === 200) {\n                    resolve(res.headers);\n                    return;\n                }\n                if (body) {\n                    try {\n                        const { msg, code, id } = JSON.parse(body);\n                        reject(new HttpException(msg, code));\n                    } catch (err) {\n                        reject(new HttpException(\"响应体解析错误\", 402));\n                    }\n                } else {\n                    reject(new HttpException(\"响应体不存在\", 402));\n                }\n                return;\n            });\n        });\n        return {\n            fileSize: +headers[\"x-upyun-file-size\"],\n            fileDate: +headers[\"x-upyun-file-date\"],\n            fileMd5: headers[\"content-md5\"]\n        };\n    }\n\n    /* 获取指定空间下文件\\目录列表\n       响应头信息中指明了分页位置\n       响应体为换行符、空格拼接的字符串，列分别为\n       文件名/目录名  类型(N表示文件、F标志目录) 大小 最后修改时间\n     */\n    async getFileList(bucket: Bucket): Promise<any> {\n        const saveKey = `/${bucket.directory}`;\n        const requestUrl = `${this.apihost}/${bucket.name}${saveKey}`;\n        const url = `/${bucket.name}${saveKey}`;\n        const date: string = new Date(+new Date() + bucket.requestExpire * 1000).toUTCString();\n        const Authorization = await this.authUtil.getHeaderAuth(bucket, \"GET\", url, date, \"\");\n        const body: any = await new Promise((resolve, reject) => {\n            request.get({\n                url: requestUrl,\n                headers: {\n                    Authorization,\n                    Date: date\n                }\n            }, (err, res, body) => {\n                if (err) {\n                    reject(new HttpException(\"获取文件信息失败\", 402));\n                    return;\n                }\n                if (res.statusCode === 200) {\n                    resolve(body);\n                    return;\n                }\n                reject(new HttpException(\"获取文件列表失败\", 402));\n                return;\n            });\n        });\n        const info = body.split(\"\\n\").map((value, index, raw) => {\n            const temp = value.split(\"\\t\");\n            return {\n                name: temp[0],\n                isDirectory: (temp[1] === \"N\" ? false : true),\n                size: parseInt(temp[2]),\n                timestamp: parseInt(temp[3])\n            };\n        });\n        return info;\n    }\n}\n"]}